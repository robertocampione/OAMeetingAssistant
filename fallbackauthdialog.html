<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Fallback SSO</title>
    <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
    <style>
      body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    </style>
  </head>
  <body>Authenticating...</body>
    <script>
    (function () {
      const hash = window.location.hash || "";
      const params = new URLSearchParams(hash.startsWith("#") ? hash.slice(1) : hash);
      const accessToken = params.get("access_token") || "";
    
      const started = Date.now();
      const TIMEOUT = 120000;
    
      function trySend() {
        // 1) In an Office dialog → messageParent
        try {
          if (Office && Office.context && Office.context.ui &&
              typeof Office.context.ui.messageParent === "function") {
            Office.context.ui.messageParent(hash || "error=NoHash");
            window.close();
            return;
          }
        } catch (_) { /* Office not ready yet */ }
    
        // 2) In a plain popup opened by window.open → postMessage to opener
        try {
          if (window.opener && !window.opener.closed) {
            window.opener.postMessage({ message: "token", accessToken, raw: hash }, "*");
            window.close();
            return;
          }
        } catch (_) { /* ignore and retry */ }
    
        // 3) Retry a bit; bail on timeout
        if (Date.now() - started > TIMEOUT) {
          document.body.textContent = "Auth dialog timed out.";
          return;
        }
        setTimeout(trySend, 200);
      }
    
      trySend();
    })();
    </script>
</html>
