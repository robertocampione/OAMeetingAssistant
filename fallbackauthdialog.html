<script>
  (function () {
    const hash = window.location.hash || "";
    const start = Date.now();
    const TIMEOUT_MS  = 120000; // up to 2 min in bad networks
    const TICK_FAST   = 50;     // fast spin first
    const TICK_NORMAL = 250;    // then relax
    let attempts = 0;

    function trySend() {
      attempts++;

      // 1) Try immediately if the API exists (best case)
      try {
        if (Office && Office.context && Office.context.ui && typeof Office.context.ui.messageParent === "function") {
          Office.context.ui.messageParent(hash || "error=NoHash");
          return;
        }
      } catch (e) {
        // Office object not ready yet, keep trying
      }

      // 2) Try to *kick* Office init early
      try {
        if (typeof Office !== "undefined" && typeof Office.onReady === "function") {
          Office.onReady(function () {
            trySend();
          });
        }
      } catch (e) {
        // ignore
      }

      // 3) Stop after timeout
      if (Date.now() - start > TIMEOUT_MS) {
        document.body.textContent =
          "Auth dialog timed out waiting for permission to communicate with the add-in.";
        return;
      }

      // 4) Keep pollingâ€”very fast for a few seconds, then slower
      setTimeout(trySend, attempts < 60 ? TICK_FAST : TICK_NORMAL);
    }

    trySend();
  })();
</script>
